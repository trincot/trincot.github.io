<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="UTF-8">
  <meta name="description" content="Online emulator of Little Man Computer. You can edit your program, have it assembled to opcodes, execute them step by step and inspect mailboxes">
  <meta name="keywords" content="LMC,assembler,simulator,emulator,opcode,von neumann,stack overflow">
  <title>Little Man Computer - Trincot's online emulator</title>
  <style>
    textarea { border: none; white-space: pre; min-width: 50% }
  </style>
</head>
<body>

<script src="https://cdn.jsdelivr.net/gh/trincot/lmc@v0.79/lmc.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Get URL parameter with base64 encoded program
    let urlParams = new URLSearchParams(location.search);
    let program;
    try {
        program = decode(urlParams.get("code") || "");
    } catch(e) {}
    
    let lmc = new LmcGui(document.body);
    
    let btnLoad = document.createElement("button");    
    btnLoad.textContent = "Edit";
    lmc.gui.run.insertAdjacentElement("beforebegin", btnLoad);
    btnLoad.addEventListener("click", () => editArea.parentNode ? reload() : edit());
    
    // load program in text area
    let editArea = document.createElement("textarea");
    edit();
    if (program) {
        editArea.value = program;
        assemble();
    } else {
        editArea.value = `; Enter your LMC code here. Then click Assemble and Run.
; For the syntax, see Wikipedia on "Little Man Computer".
; This demo takes two input values, and outputs the greatest of the two:
          INP
          STA first
          INP
          SUB first
          BRP firstMost
          LDA first 
          BRA output
firstMost ADD first
output    OUT
          HLT
first     DAT`;
    }

    function edit() {
        lmc.load(); // Stop execution
        lmc.gui.run.disabled = lmc.gui.walk.disabled = lmc.gui.step.disabled = lmc.gui.totop.disabled = lmc.gui.reload.disabled = true;
        lmc.gui.code.replaceWith(editArea);
        editArea.focus();
        btnLoad.textContent = "Assemble";
    }
    
    function assemble() {
        editArea.replaceWith(lmc.gui.code);
        btnLoad.textContent = "Edit";
        lmc.load(editArea.value);
        lmc.gui.reload.disabled = false;
    }
    
    function reload() {
        location.href = location.href.split("?")[0] + "?code=" + (encode(editArea.value) || "");
    }
    
    function encode(s) {
        return encodeURIComponent(s).replace(/%20/g, "+");
    }
    
    function decode(s) {
        return s;
    }
});
</script>

</body>
</html>
